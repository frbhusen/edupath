
  {% extends 'base.html' %}
  {% block content %}
  <div class="row mb-3">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{{ url_for('teacher.dashboard') }}">لوحة التحكم</a></li>
          <li class="breadcrumb-item active">تعديل الاختبار</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-12 col-xl-11">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
          <div>
            <h4 class="mb-1">تعديل الاختبار</h4>
            <div class="small opacity-75">{{ test.title }}</div>
          </div>
          <div class="text-end">
            <div class="small">القسم</div>
            <div class="fw-semibold">{{ test.section.title }}</div>
          </div>
        </div>
        <div class="card-body">
          <div class="card border-0 bg-light mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">إعدادات الاختبار</h5>
                <span class="badge text-bg-secondary">{{ test.questions|length }} سؤال</span>
              </div>
              <form method="post">
                {{ meta_form.hidden_tag() }}
                <input type="hidden" name="form_name" value="update_test" />
                <div class="row g-3">
                  <div class="col-12 col-lg-4">
                    {{ meta_form.title.label(class="form-label") }}
                    {{ meta_form.title(class="form-control") }}
                  </div>
                  <div class="col-12 col-lg-4">
                    {{ meta_form.lesson_id.label(class="form-label") }}
                    {{ meta_form.lesson_id(class="form-select") }}
                    <div class="form-text">ربط بدرس أو إبقاءه على مستوى القسم.</div>
                  </div>
                  <div class="col-12 col-lg-4">
                    <label class="form-label">الوصول</label>
                    <div class="form-check">
                      {{ meta_form.requires_code(class="form-check-input", id="test_requires_code") }}
                      <label class="form-check-label" for="test_requires_code">يتطلب رمز تفعيل</label>
                    </div>
                    <div class="form-text">يمكن قفل الاختبار أو فتحه عبر رمز التفعيل.</div>
                  </div>
                  <div class="col-12">
                    {{ meta_form.description.label(class="form-label") }}
                    {{ meta_form.description(class="form-control", rows=2) }}
                  </div>
                  <div class="col-12 col-md-4 ms-auto">
                    {{ meta_form.submit(class="btn btn-cta w-100") }}
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="row g-4">
            <div class="col-12 col-lg-7">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">تحرير الأسئلة</h5>
                    <small class="text-muted">إنشاء، تعديل، وحذف</small>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">اختر سؤال موجود</label>
                    <select id="questionSelect" class="form-select">
                      <option value="">سؤال جديد</option>
                      {% for q in test.questions %}
                        {% set choices = q.choices|list %}
                        {% set c1 = choices[0] if choices|length > 0 else None %}
                        {% set c2 = choices[1] if choices|length > 1 else None %}
                        {% set c3 = choices[2] if choices|length > 2 else None %}
                        {% set c4 = choices[3] if choices|length > 3 else None %}
                        {% set choices_json = '[' %}
                        {% for ch in choices %}
                          {% set choices_json = choices_json + '{"text":' + (ch.text|tojson) + ',"image_url":' + ((ch.image_url|tojson) if ch.image_url else 'null') + ',"is_correct":' + ('true' if ch.is_correct else 'false') + '}' + (',' if not loop.last else '') %}
                        {% endfor %}
                        {% set choices_json = choices_json + ']' %}
                        {% set correct_idx = namespace(value=0) %}
                        {% for ch in choices %}
                          {% if q.correct_choice_id and ch.choice_id == q.correct_choice_id %}
                            {% set correct_idx.value = loop.index %}
                          {% elif ch.is_correct %}
                            {% set correct_idx.value = loop.index %}
                          {% endif %}
                        {% endfor %}
                        <option value="{{ q.id }}"
                          data-text="{{ q.text }}"
                          data-images='{{ (q.question_images or [])|tojson|e }}'
                          data-hint="{{ q.hint or '' }}"
                          data-difficulty="{{ q.difficulty or 'medium' }}"
                          data-choices='{{ choices_json|e }}'
                          data-choice1="{{ c1.text if c1 else '' }}"
                          data-choice1img="{{ c1.image_url if c1 else '' }}"
                          data-choice2="{{ c2.text if c2 else '' }}"
                          data-choice2img="{{ c2.image_url if c2 else '' }}"
                          data-choice3="{{ c3.text if c3 else '' }}"
                          data-choice3img="{{ c3.image_url if c3 else '' }}"
                          data-choice4="{{ c4.text if c4 else '' }}"
                          data-choice4img="{{ c4.image_url if c4 else '' }}"
                          data-correct="{{ correct_idx.value }}">
                          Q{{ loop.index }} - {{ q.text[:40] ~ ('...' if q.text|length > 40 else '') }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <form method="post" id="saveTestQuestionsForm" class="mb-3">
                    <input type="hidden" name="form_name" value="save_test_questions" />
                    <input type="hidden" name="draft_questions" id="draftQuestionsField" />
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                      <button type="button" class="btn btn-success btn-sm" id="saveTestBtn">حفظ الاختبار</button>
                      <span class="small text-muted">يرفع جميع الأسئلة دفعة واحدة.</span>
                    </div>
                  </form>

                  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                    <button type="button" class="btn btn-outline-danger btn-sm" id="batchDeleteBtn" disabled>حذف الأسئلة المحددة</button>
                    <span class="small text-muted">حدد الأسئلة من القائمة أدناه.</span>
                  </div>

                  <form method="post" id="questionForm">
                    <input type="hidden" name="question_id" id="question_id" />
                    <div class="mb-3">
                      <label class="form-label">السؤال</label>
                      <textarea class="form-control" id="question_text" name="question_text" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">صور السؤال (رابط لكل سطر)</label>
                      <textarea class="form-control" id="question_images" name="question_images" rows="2" placeholder="https://..."></textarea>
                    </div>
                    <div class="row g-3">
                      <div class="col-12 col-md-6">
                        <label class="form-label">مستوى السؤال</label>
                        <select class="form-select" id="question_difficulty" name="difficulty">
                          <option value="easy">سهل</option>
                          <option value="medium" selected>متوسط</option>
                          <option value="hard">صعب</option>
                        </select>
                      </div>
                      <div class="col-12 col-md-6 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-secondary w-100" id="toggleHintBtn">إضافة تلميح</button>
                      </div>
                    </div>
                    <div class="mb-3 d-none" id="hintWrapper">
                      <label class="form-label">التلميح</label>
                      <textarea class="form-control" id="question_hint" name="question_hint" rows="2"></textarea>
                    </div>

                    <div class="mt-3">
                      <label class="form-label">الإجابات</label>
                      <div class="row g-2" id="choicesContainer">
                        {% for i in range(1,5) %}
                        <div class="col-12 choice-row" data-choice-index="{{ i }}">
                          <div class="input-group">
                            <div class="input-group-text">
                              <input class="form-check-input mt-0 choice-correct" type="radio" name="correct_choice" id="correct_choice_{{ i }}" value="{{ i }}" aria-label="Correct choice">
                            </div>
                            <input type="text" class="form-control choice-text" name="choice_{{ i }}" id="choice_{{ i }}" placeholder="الخيار {{ i }}">
                          </div>
                          <input type="text" class="form-control mt-2 choice-image" name="choice_{{ i }}_image" id="choice_{{ i }}_image" placeholder="رابط صورة الخيار {{ i }} (اختياري)">
                        </div>
                        {% endfor %}
                      </div>
                      <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="addChoiceBtn">إضافة خيار</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="removeChoiceBtn">حذف خيار</button>
                        <span class="small text-muted">الحد الأدنى: خياران.</span>
                      </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                      <button type="button" class="btn btn-primary w-100" id="saveQuestionBtn">حفظ السؤال</button>
                      <button type="button" id="resetBtn" class="btn btn-outline-secondary">تفريغ</button>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                      <button type="button" id="deleteBtn" class="btn btn-outline-danger w-100" disabled>حذف السؤال المختار</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-5">
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">المعاينة الحية</h6>
                    <span class="badge text-bg-light">MathJax</span>
                  </div>
                  <div class="mb-2"><strong>السؤال:</strong> <span id="previewQuestion"></span></div>
                  <div class="mb-2"><strong>التلميح:</strong> <span id="previewHint"></span></div>
                  <div><strong>الخيارات:</strong>
                    <ol class="mb-0" id="previewChoices"></ol>
                  </div>
                </div>
              </div>

              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="card-title mb-0">قائمة الأسئلة</h6>
                    <span class="badge text-bg-secondary">{{ test.questions|length }}</span>
                  </div>
                  <div class="list-group list-group-flush" id="questionList"></div>
                  <div class="alert alert-info mb-0 d-none" id="emptyQuestions">لا توجد أسئلة حتى الآن. قم بإضافة سؤالك الأول.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">استيراد الأسئلة من JSON</h5>
                <span class="badge text-bg-light">يدعم LaTeX</span>
              </div>
              <p class="text-muted small">قم بتحميل ملف JSON أو لصق المحتوى مباشرة.</p>
              <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="form_name" value="import_json" />
                <div class="row g-3">
                  <div class="col-12 col-lg-6">
                    <label class="form-label">ملف JSON</label>
                    <input type="file" class="form-control" name="questions_file" accept="application/json" />
                  </div>
                  <div class="col-12 col-lg-6">
                    <label class="form-label">مستوى الأسئلة المستوردة</label>
                    <select class="form-select" name="import_difficulty">
                      <option value="from_json" selected>حسب JSON</option>
                      <option value="easy">سهل</option>
                      <option value="medium">متوسط</option>
                      <option value="hard">صعب</option>
                    </select>
                    <div class="form-text">اختر مستوى واحد لتطبيقه على جميع الأسئلة المستوردة.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">أو لصق JSON</label>
                    <textarea class="form-control" name="questions_json" rows="6" placeholder='{"quiz": [...]}'>
                    </textarea>
                  </div>
                  <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary" id="toggleImportHintBtn">إضافة تلميح</button>
                  </div>
                  <div class="col-12 d-none" id="importHintWrapper">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeHints" name="include_hints" value="1" checked>
                      <label class="form-check-label" for="includeHints">تضمين التلميحات من JSON</label>
                    </div>
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-cta">استيراد الأسئلة</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const selectEl = document.getElementById('questionSelect');
    const idField = document.getElementById('question_id');
    const questionField = document.getElementById('question_text');
    const questionImagesField = document.getElementById('question_images');
    const hintField = document.getElementById('question_hint');
    const difficultyField = document.getElementById('question_difficulty');
    const choicesContainer = document.getElementById('choicesContainer');
    const addChoiceBtn = document.getElementById('addChoiceBtn');
    const removeChoiceBtn = document.getElementById('removeChoiceBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const resetBtn = document.getElementById('resetBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const saveQuestionBtn = document.getElementById('saveQuestionBtn');
    const saveTestBtn = document.getElementById('saveTestBtn');
    const questionForm = document.getElementById('questionForm');
    const saveTestForm = document.getElementById('saveTestQuestionsForm');
    const draftQuestionsField = document.getElementById('draftQuestionsField');
    const questionList = document.getElementById('questionList');
    const emptyQuestions = document.getElementById('emptyQuestions');
    const testId = "{{ test.id }}";
    const toggleHintBtn = document.getElementById('toggleHintBtn');
    const hintWrapper = document.getElementById('hintWrapper');
    const toggleImportHintBtn = document.getElementById('toggleImportHintBtn');
    const importHintWrapper = document.getElementById('importHintWrapper');
    const previewQuestion = document.getElementById('previewQuestion');
    const previewHint = document.getElementById('previewHint');
    const previewChoices = document.getElementById('previewChoices');

    function getChoiceFields(){
      return Array.from(document.querySelectorAll('.choice-text'));
    }

    function getChoiceImageFields(){
      return Array.from(document.querySelectorAll('.choice-image'));
    }

    function getCorrectRadios(){
      return Array.from(document.querySelectorAll('.choice-correct'));
    }

    let draftQuestions = [];
    const draftKey = `test_draft_${testId}`;

    function buildDraftFromOptions(){
      return Array.from(selectEl.options)
        .filter(opt => opt.value)
        .map((opt) => {
          let images = [];
          if (opt.dataset.images) {
            try {
              images = JSON.parse(opt.dataset.images) || [];
            } catch (err) {
              images = [];
            }
          }
          let choices = [];
          if (opt.dataset.choices) {
            try {
              choices = JSON.parse(opt.dataset.choices) || [];
            } catch (err) {
              choices = [];
            }
          }
          if (choices.length === 0) {
            const fallback = [
              { text: opt.dataset.choice1 || '', image_url: opt.dataset.choice1img || '', is_correct: false },
              { text: opt.dataset.choice2 || '', image_url: opt.dataset.choice2img || '', is_correct: false },
              { text: opt.dataset.choice3 || '', image_url: opt.dataset.choice3img || '', is_correct: false },
              { text: opt.dataset.choice4 || '', image_url: opt.dataset.choice4img || '', is_correct: false }
            ].filter(c => c.text);
            choices = fallback;
          }
          return {
            id: opt.value,
            text: opt.dataset.text || '',
            hint: opt.dataset.hint || '',
            difficulty: opt.dataset.difficulty || 'medium',
            question_images: images,
            choices: choices
          };
        });
    }

    function loadDraft(){
      const raw = localStorage.getItem(draftKey);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            draftQuestions = parsed;
            return;
          }
        } catch (err) {
          // ignore invalid cache
        }
      }
      draftQuestions = buildDraftFromOptions();
    }

    function saveDraft(){
      localStorage.setItem(draftKey, JSON.stringify(draftQuestions));
    }

    function rebuildQuestionSelect(){
      const current = selectEl.value;
      selectEl.innerHTML = '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = 'سؤال جديد';
      selectEl.appendChild(emptyOpt);
      draftQuestions.forEach((q, idx) => {
        const opt = document.createElement('option');
        opt.value = q.id;
        opt.dataset.text = q.text || '';
        opt.dataset.hint = q.hint || '';
        opt.dataset.difficulty = q.difficulty || 'medium';
        opt.dataset.images = JSON.stringify(q.question_images || []);
        opt.dataset.choices = JSON.stringify(q.choices || []);
        opt.textContent = `Q${idx + 1} - ${q.text ? q.text.slice(0, 40) : ''}${q.text && q.text.length > 40 ? '...' : ''}`;
        selectEl.appendChild(opt);
      });
      if (current && Array.from(selectEl.options).some(opt => opt.value === current)) {
        selectEl.value = current;
      } else {
        selectEl.value = '';
      }
    }

    function renderQuestionList(){
      if (!questionList) return;
      questionList.innerHTML = '';
      if (draftQuestions.length === 0) {
        if (emptyQuestions) emptyQuestions.classList.remove('d-none');
        return;
      }
      if (emptyQuestions) emptyQuestions.classList.add('d-none');
      draftQuestions.forEach((q, idx) => {
        const correct = (q.choices || []).find(c => c.is_correct);
        const diffLabel = q.difficulty === 'easy' ? 'سهل' : q.difficulty === 'hard' ? 'صعب' : 'متوسط';
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
          <div class="d-flex align-items-start gap-2">
            <input class="form-check-input mt-1 question-select" type="checkbox" value="${q.id}" aria-label="Select question" />
            <button class="btn btn-link p-0 text-start flex-grow-1 text-decoration-none" type="button" data-question-id="${q.id}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <div class="fw-semibold">س${idx + 1}. ${q.text || ''}</div>
                  ${q.hint ? `<div class="small text-muted">التلميح: ${q.hint}</div>` : ''}
                  <div class="small text-muted">صحيح: ${correct ? correct.text : 'غير محدد'}</div>
                </div>
                <span class="badge text-bg-light">${diffLabel}</span>
              </div>
            </button>
          </div>
        `;
        questionList.appendChild(item);
      });

      questionList.querySelectorAll('button[data-question-id]').forEach((btn) => {
        btn.addEventListener('click', () => {
          selectQuestion(btn.dataset.questionId);
        });
      });

      questionList.querySelectorAll('.question-select').forEach((el) => {
        el.addEventListener('change', updateBatchDeleteState);
      });

      updateBatchDeleteState();
    }

    function createChoiceRow(index, text, imageUrl, isCorrect){
      const wrapper = document.createElement('div');
      wrapper.className = 'col-12 choice-row';
      wrapper.dataset.choiceIndex = index;
      wrapper.innerHTML = `
        <div class="input-group">
          <div class="input-group-text">
            <input class="form-check-input mt-0 choice-correct" type="radio" name="correct_choice" id="correct_choice_${index}" value="${index}" aria-label="Correct choice">
          </div>
          <input type="text" class="form-control choice-text" name="choice_${index}" id="choice_${index}" placeholder="الخيار ${index}">
        </div>
        <input type="text" class="form-control mt-2 choice-image" name="choice_${index}_image" id="choice_${index}_image" placeholder="رابط صورة الخيار ${index} (اختياري)">
      `;
      choicesContainer.appendChild(wrapper);
      const textField = wrapper.querySelector('.choice-text');
      const imageField = wrapper.querySelector('.choice-image');
      const radioField = wrapper.querySelector('.choice-correct');
      if (textField) textField.value = text || '';
      if (imageField) imageField.value = imageUrl || '';
      if (radioField) radioField.checked = Boolean(isCorrect);
      if (textField) textField.addEventListener('input', updatePreview);
      if (imageField) imageField.addEventListener('input', updatePreview);
      if (radioField) radioField.addEventListener('change', updatePreview);
    }

    function resetChoices(){
      if (!choicesContainer) return;
      choicesContainer.innerHTML = '';
    }

    function seedDefaultChoices(){
      resetChoices();
      for (let i = 1; i <= 4; i += 1){
        createChoiceRow(i, '', '', false);
      }
    }

    function fillFormFromOption(opt){
      if(!opt || !opt.value){
        idField.value = '';
        questionField.value = '';
        if (questionImagesField) questionImagesField.value = '';
        hintField.value = '';
        if (difficultyField) difficultyField.value = 'medium';
        seedDefaultChoices();
        deleteBtn.disabled = true;
        updatePreview();
        return;
      }
      idField.value = opt.value;
      questionField.value = opt.dataset.text || '';
      if (questionImagesField) {
        let images = [];
        if (opt.dataset.images) {
          try {
            images = JSON.parse(opt.dataset.images) || [];
          } catch (err) {
            images = [];
          }
        }
        questionImagesField.value = images.join('\n');
      }
      hintField.value = opt.dataset.hint || '';
      if (difficultyField) difficultyField.value = opt.dataset.difficulty || 'medium';
      let choicesData = [];
      if (opt.dataset.choices) {
        try {
          choicesData = JSON.parse(opt.dataset.choices) || [];
        } catch (err) {
          choicesData = [];
        }
      }
      if (choicesData.length === 0) {
        const fallback = [
          { text: opt.dataset.choice1 || '', image_url: opt.dataset.choice1img || '', is_correct: false },
          { text: opt.dataset.choice2 || '', image_url: opt.dataset.choice2img || '', is_correct: false },
          { text: opt.dataset.choice3 || '', image_url: opt.dataset.choice3img || '', is_correct: false },
          { text: opt.dataset.choice4 || '', image_url: opt.dataset.choice4img || '', is_correct: false }
        ].filter(c => c.text);
        choicesData = fallback;
      }
      resetChoices();
      if (choicesData.length === 0) {
        seedDefaultChoices();
      } else {
        choicesData.forEach((choice, idx) => {
          createChoiceRow(idx + 1, choice.text, choice.image_url, choice.is_correct);
        });
        const rows = document.querySelectorAll('.choice-row');
        if (rows.length < 2) {
          for (let i = rows.length + 1; i <= 2; i += 1) {
            createChoiceRow(i, '', '', false);
          }
        }
      }
      deleteBtn.disabled = false;
      updatePreview();
    }

    function collectQuestionFromForm(){
      const text = (questionField.value || '').trim();
      const hint = (hintField.value || '').trim();
      const difficulty = (difficultyField && difficultyField.value) ? difficultyField.value : 'medium';
      const images = (questionImagesField && questionImagesField.value)
        ? questionImagesField.value.split(/\r?\n/).map(v => v.trim()).filter(Boolean)
        : [];

      const fields = getChoiceFields();
      const imageFields = getChoiceImageFields();
      const radios = getCorrectRadios();
      const choices = [];
      fields.forEach((field, idx) => {
        const val = (field.value || '').trim();
        if (!val) return;
        const imageVal = imageFields[idx] ? (imageFields[idx].value || '').trim() : '';
        choices.push({
          text: val,
          image_url: imageVal || null,
          is_correct: Boolean(radios[idx] && radios[idx].checked)
        });
      });

      if (!text) {
        alert('نص السؤال مطلوب.');
        return null;
      }

      if (choices.length < 2) {
        alert('يجب إضافة خيارين على الأقل.');
        return null;
      }

      if (!choices.some(c => c.is_correct)) {
        choices[0].is_correct = true;
      }

      const id = idField.value || `draft-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      return {
        id,
        text,
        hint,
        difficulty,
        question_images: images,
        choices
      };
    }

    selectEl.addEventListener('change', (e)=>{
      const opt = e.target.selectedOptions[0];
      fillFormFromOption(opt);
    });

    resetBtn.addEventListener('click', ()=>{
      selectEl.value = '';
      fillFormFromOption(selectEl.selectedOptions[0]);
    });

    deleteBtn.addEventListener('click', ()=>{
      const qid = idField.value;
      if(!qid) return;
      if(!confirm('حذف السؤال؟')) return;
      draftQuestions = draftQuestions.filter(q => q.id !== qid);
      saveDraft();
      rebuildQuestionSelect();
      renderQuestionList();
      selectEl.value = '';
      fillFormFromOption(selectEl.selectedOptions[0]);
    });

    if (saveQuestionBtn) {
      saveQuestionBtn.addEventListener('click', () => {
        const draft = collectQuestionFromForm();
        if (!draft) return;
        const idx = draftQuestions.findIndex(q => q.id === draft.id);
        if (idx >= 0) {
          draftQuestions[idx] = draft;
        } else {
          draftQuestions.push(draft);
        }
        saveDraft();
        rebuildQuestionSelect();
        renderQuestionList();
        selectEl.value = draft.id;
        fillFormFromOption(selectEl.selectedOptions[0]);
      });
    }

    if (questionForm) {
      questionForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (saveQuestionBtn) saveQuestionBtn.click();
      });
    }

    if (saveTestBtn && saveTestForm && draftQuestionsField) {
      saveTestBtn.addEventListener('click', () => {
        draftQuestionsField.value = JSON.stringify(draftQuestions);
        saveTestForm.submit();
      });
    }

    function updatePreview(){
      if(previewQuestion) previewQuestion.textContent = questionField.value || '';
      if(previewHint) previewHint.textContent = hintField.value || '';
      if(previewChoices){
        previewChoices.innerHTML = '';
        const fields = getChoiceFields();
        const radios = getCorrectRadios();
        fields.forEach((field, idx) => {
          if(!field.value) return;
          const li = document.createElement('li');
          const prefix = radios[idx] && radios[idx].checked ? '✅ ' : '';
          li.textContent = `${prefix}${field.value}`;
          previewChoices.appendChild(li);
        });
      }
      if(window.MathJax && MathJax.typesetPromise){
        MathJax.typesetPromise([previewQuestion, previewHint, previewChoices]);
      }
    }

    [questionField, questionImagesField, hintField].forEach(el => {
      if (!el) return;
      el.addEventListener('input', updatePreview);
    });

    function bindChoiceListeners(){
      getChoiceFields().forEach(el => el.addEventListener('input', updatePreview));
      getChoiceImageFields().forEach(el => el.addEventListener('input', updatePreview));
      getCorrectRadios().forEach(r => r.addEventListener('change', updatePreview));
    }

    if (addChoiceBtn) {
      addChoiceBtn.addEventListener('click', () => {
        const count = document.querySelectorAll('.choice-row').length;
        createChoiceRow(count + 1, '', '', false);
        bindChoiceListeners();
      });
    }

    if (removeChoiceBtn) {
      removeChoiceBtn.addEventListener('click', () => {
        const rows = document.querySelectorAll('.choice-row');
        if (rows.length <= 2) {
          alert('لا يمكن أن يقل عدد الخيارات عن خيارين.');
          return;
        }
        const last = rows[rows.length - 1];
        if (last) {
          last.remove();
          updatePreview();
        }
      });
    }

    function updateBatchDeleteState(){
      if (!batchDeleteBtn) return [];
      const selected = Array.from(document.querySelectorAll('.question-select:checked')).map(el => el.value);
      batchDeleteBtn.disabled = selected.length === 0;
      return selected;
    }

    if (batchDeleteBtn) {
      batchDeleteBtn.addEventListener('click', () => {
        if (batchDeleteBtn.disabled) return;
        if (!confirm('حذف الأسئلة المحددة؟')) return;
        const selected = updateBatchDeleteState();
        if (selected.length === 0) return;
        draftQuestions = draftQuestions.filter(q => !selected.includes(q.id));
        saveDraft();
        rebuildQuestionSelect();
        renderQuestionList();
        if (selected.includes(idField.value)) {
          selectEl.value = '';
          fillFormFromOption(selectEl.selectedOptions[0]);
        }
      });
    }

    if(toggleHintBtn && hintWrapper){
      toggleHintBtn.addEventListener('click', ()=>{
        hintWrapper.classList.toggle('d-none');
        toggleHintBtn.textContent = hintWrapper.classList.contains('d-none') ? 'إضافة تلميح' : 'إزالة التلميح';
        if(hintWrapper.classList.contains('d-none')){
          hintField.value = '';
          updatePreview();
        }
      });
    }

    if(toggleImportHintBtn && importHintWrapper){
      toggleImportHintBtn.addEventListener('click', ()=>{
        importHintWrapper.classList.toggle('d-none');
        toggleImportHintBtn.textContent = importHintWrapper.classList.contains('d-none') ? 'إضافة تلميح' : 'إزالة التلميح';
      });
    }

    function selectQuestion(id){
      const opt = Array.from(selectEl.options).find(o => o.value === String(id));
      if(opt){
        selectEl.value = String(id);
        fillFormFromOption(opt);
      }
    }
    window.selectQuestion = selectQuestion;

    loadDraft();
    saveDraft();
    rebuildQuestionSelect();
    renderQuestionList();
    seedDefaultChoices();
    bindChoiceListeners();
    fillFormFromOption(selectEl.selectedOptions[0]);
    updatePreview();
  </script>
  {% endblock %}
