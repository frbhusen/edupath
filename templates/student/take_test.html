{% extends 'base.html' %}
{% block content %}
<div class="dashboard-hero mb-3 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h4 mb-1">{{ test.title }}</h1>
    <p class="mb-0">{{ test.description or 'أجب عن جميع الأسئلة أدناه.' }}</p>
  </div>
  {% if selected_count %}
    <div class="text-end">
      <div class="small text-muted">الوقت المتبقي</div>
      <div id="test-timer" class="badge text-bg-warning fs-6" data-duration="{{ time_limit_seconds }}">--:--</div>
    </div>
  {% endif %}
  <a class="btn btn-light btn-sm" href="{{ url_for('student.section_detail', section_id=test.section.id) }}">رجوع</a>
</div>

{% if not selected_count %}
  <form method="get" class="card shadow-sm">
    <div class="card-body">
      <label class="form-label" for="questionRange">كم عدد الأسئلة التي تريدها؟ (10-50)</label>
      {% if min_select == max_select %}
        <div class="d-flex align-items-center gap-3">
          <input type="hidden" name="count" value="{{ max_select }}" />
          <span class="badge text-bg-secondary">{{ max_select }}</span>
          <span class="text-muted small">خيار واحد فقط متاح.</span>
        </div>
      {% else %}
        <div class="d-flex align-items-center gap-3">
          <input
            type="range"
            class="form-range"
            id="questionRange"
            name="count"
            min="{{ min_select }}"
            max="{{ max_select }}"
            value="{{ max_select }}"
            oninput="document.getElementById('questionCountValue').textContent = this.value"
          />
          <span class="badge text-bg-secondary" id="questionCountValue">{{ max_select }}</span>
        </div>
      {% endif %}
      <div class="small text-muted mt-1">الأسئلة المتاحة: {{ total_questions }}</div>
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-cta">بدء الاختبار</button>
      </div>
    </div>
  </form>
{% else %}
  <form method="post" id="test-form">
    <input type="hidden" name="question_ids" value="{{ question_ids_str }}" />
    <input type="hidden" name="time_expired" id="time-expired" value="0" />
    {% for item in ordered_questions %}
      {% set q = item.question %}
      {% set choices = item.choices %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <p class="fw-semibold">س{{ loop.index }}. {{ q.text }}</p>
          <div class="list-group">
            {% for c in choices %}
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input me-2" type="radio" name="question_{{ q.id }}" value="{{ c.choice_id }}">
                <span>{{ c.text }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
    <div class="d-grid">
      <button type="submit" class="btn btn-cta btn-lg">إرسال الإجابات</button>
    </div>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // New timer system - pure JavaScript countdown
  (function() {
    const timerElement = document.getElementById('test-timer');
    const testForm = document.getElementById('test-form');
    const expiredInput = document.getElementById('time-expired');
    
    if (!timerElement || !testForm) return;
    
    const totalSeconds = parseInt(timerElement.dataset.duration, 10);
    if (!totalSeconds || totalSeconds <= 0) return;
    
    let remainingSeconds = totalSeconds;
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    function updateTimer() {
      timerElement.textContent = formatTime(remainingSeconds);
      
      if (remainingSeconds <= 0) {
        if (expiredInput) {
          expiredInput.value = '1';
        }
        testForm.submit();
        return;
      }
      
      remainingSeconds--;
      setTimeout(updateTimer, 1000);
    }
    
    // Start the timer immediately
    updateTimer();
  })();
</script>
{% endblock %}
