{% extends 'base.html' %}
{% block content %}
<div class="dashboard-hero mb-3 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h4 mb-1">{{ test.title }}</h1>
    <p class="mb-0">{{ test.description or 'أجب عن جميع الأسئلة أدناه.' }}</p>
  </div>
  {% if selected_count %}
    <div class="text-end">
      <div class="small text-muted">الوقت المتبقي</div>
      <div id="test-timer" class="badge text-bg-warning fs-6" data-duration="{{ time_limit_seconds }}">--:--</div>
    </div>
  {% endif %}
  <a class="btn btn-light btn-sm" href="{{ url_for('student.section_detail', section_id=test.section.id) }}">رجوع</a>
</div>

{% if not selected_count %}
  <form method="get" class="card shadow-sm">
    <div class="card-body">
      <label class="form-label" for="questionRange">كم عدد الأسئلة التي تريدها؟ (10-50)</label>
      {% if min_select == max_select %}
        <div class="d-flex align-items-center gap-3">
          <input type="hidden" name="count" value="{{ max_select }}" />
          <span class="badge text-bg-secondary">{{ max_select }}</span>
          <span class="text-muted small">خيار واحد فقط متاح.</span>
        </div>
      {% else %}
        <div class="d-flex align-items-center gap-3">
          <input
            type="range"
            class="form-range"
            id="questionRange"
            name="count"
            min="{{ min_select }}"
            max="{{ max_select }}"
            value="{{ max_select }}"
            oninput="document.getElementById('questionCountValue').textContent = this.value"
          />
          <span class="badge text-bg-secondary" id="questionCountValue">{{ max_select }}</span>
        </div>
      {% endif %}
      <div class="small text-muted mt-1">الأسئلة المتاحة: {{ total_questions }}</div>

      <div class="mt-4">
        <div class="fw-semibold mb-2">اختر توزيع الصعوبات</div>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <label class="form-label">سهل ({{ available_easy }})</label>
            <input class="form-control difficulty-input" type="number" name="easy" min="0" max="{{ available_easy }}" value="0" data-difficulty="easy" />
            <div class="difficulty-error small text-danger d-none mt-1"></div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">متوسط ({{ available_medium }})</label>
            <input class="form-control difficulty-input" type="number" name="medium" min="0" max="{{ available_medium }}" value="0" data-difficulty="medium" />
            <div class="difficulty-error small text-danger d-none mt-1"></div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">صعب ({{ available_hard }})</label>
            <input class="form-control difficulty-input" type="number" name="hard" min="0" max="{{ available_hard }}" value="0" data-difficulty="hard" />
            <div class="difficulty-error small text-danger d-none mt-1"></div>
          </div>
        </div>
        <div class="small text-muted mt-2">المجموع: <span id="difficulty-sum">0</span> | المتاح: 10-50</div>
      </div>

      <div class="mt-4">
        <div class="fw-semibold mb-2">قوالب جاهزة</div>
        <div class="d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('easy')">سهل</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('medium')">متوسط</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('hard')">صعب</button>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-cta">بدء الاختبار</button>
      </div>
    </div>
  </form>
{% else %}
  <form method="post" id="test-form">
    <input type="hidden" name="question_ids" value="{{ question_ids_str }}" />
    <input type="hidden" name="time_expired" id="time-expired" value="0" />
    {% for item in ordered_questions %}
      {% set q = item.question %}
      {% set choices = item.choices %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <p class="fw-semibold">س{{ loop.index }}. {{ q.text }}</p>
          {% if q.question_images %}
            <div class="d-flex flex-wrap gap-2 mb-2">
              {% for img in q.question_images %}
                <img src="{{ img }}" alt="صورة السؤال" class="img-fluid rounded border" style="max-height: 240px;">
              {% endfor %}
            </div>
          {% endif %}
          <div class="list-group">
            {% for c in choices %}
              <label class="list-group-item">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <input class="form-check-input me-2" type="radio" name="question_{{ q.id }}" value="{{ c.choice_id }}" required>
                  <span>{{ c.text }}</span>
                  {% if c.image_url %}
                    <img src="{{ c.image_url }}" alt="صورة الإجابة" class="img-fluid rounded border" style="max-height: 140px;" required>
                  {% endif %}
                </div>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
    <div class="d-grid">
      <button type="submit" class="btn btn-cta btn-lg">إرسال الإجابات</button>
    </div>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const rangeInput = document.getElementById('questionRange');
    const countBadge = document.getElementById('questionCountValue');
    const difficultyInputs = document.querySelectorAll('.difficulty-input');
    const difficultySum = document.getElementById('difficulty-sum');
    
    if (!difficultyInputs || difficultyInputs.length === 0) return;

    const inputs = {
      easy: document.querySelector('input[name="easy"]'),
      medium: document.querySelector('input[name="medium"]'),
      hard: document.querySelector('input[name="hard"]')
    };

    const hasSetupForm = inputs.easy && inputs.medium && inputs.hard;
    if (!hasSetupForm) return;

    const maxes = {
      easy: parseInt(inputs.easy.getAttribute('max') || '0', 10),
      medium: parseInt(inputs.medium.getAttribute('max') || '0', 10),
      hard: parseInt(inputs.hard.getAttribute('max') || '0', 10)
    };

    const MIN_QUESTIONS = 10;
    const MAX_QUESTIONS = 50;

    function setDisabled() {
      Object.keys(inputs).forEach((name) => {
        if (maxes[name] === 0) {
          inputs[name].value = 0;
          inputs[name].disabled = true;
        } else {
          inputs[name].disabled = false;
        }
      });
    }

    function getCurrentSum() {
      let sum = 0;
      Object.keys(inputs).forEach((name) => {
        let val = parseInt(inputs[name].value || '0', 10);
        if (Number.isNaN(val)) val = 0;
        sum += val;
      });
      return sum;
    }

    function updateSumDisplay() {
      const sum = getCurrentSum();
      if (difficultySum) {
        difficultySum.textContent = sum;
      }
    }

    function syncSliderFromInputs() {
      if (!rangeInput) return;
      const sum = getCurrentSum();
      const clamped = Math.max(MIN_QUESTIONS, Math.min(sum, MAX_QUESTIONS));
      rangeInput.value = clamped;
      if (countBadge) {
        countBadge.textContent = clamped;
      }
      updateSumDisplay();
    }

    function validateDifficultyInput(input) {
      const name = input.getAttribute('data-difficulty');
      const max = maxes[name];
      let val = parseInt(input.value || '0', 10);
      if (Number.isNaN(val)) val = 0;

      // Clamp to per-difficulty max
      val = Math.max(0, Math.min(val, max));
      input.value = val;

      // Calculate current sum
      const sum = getCurrentSum();
      const errorDiv = input.nextElementSibling;

      if (sum > MAX_QUESTIONS) {
        // Reject the input
        input.value = Math.max(0, val - (sum - MAX_QUESTIONS));
        input.classList.add('is-invalid');
        if (errorDiv && errorDiv.classList.contains('difficulty-error')) {
          errorDiv.textContent = `⚠️ تجاوزت الحد الأقصى (${MAX_QUESTIONS})`;
          errorDiv.classList.remove('d-none');
        }
        return false;
      } else {
        // Valid input
        input.classList.remove('is-invalid');
        if (errorDiv && errorDiv.classList.contains('difficulty-error')) {
          errorDiv.classList.add('d-none');
          errorDiv.textContent = '';
        }
        return true;
      }
    }

    // Attach listeners to difficulty inputs
    difficultyInputs.forEach((input) => {
      input.addEventListener('input', () => {
        validateDifficultyInput(input);
        syncSliderFromInputs();
      });
      input.addEventListener('change', () => {
        validateDifficultyInput(input);
        syncSliderFromInputs();
      });
    });

    // When slider changes, adjust distribution
    if (rangeInput) {
      rangeInput.addEventListener('input', () => {
        const target = parseInt(rangeInput.value || '0', 10);
        if (countBadge) countBadge.textContent = target;
        
        // Rebalance to match slider
        let values = {
          easy: Math.max(0, Math.min(parseInt(inputs.easy.value || '0', 10), maxes.easy)),
          medium: Math.max(0, Math.min(parseInt(inputs.medium.value || '0', 10), maxes.medium)),
          hard: Math.max(0, Math.min(parseInt(inputs.hard.value || '0', 10), maxes.hard))
        };

        let total = values.easy + values.medium + values.hard;

        if (total > target) {
          const order = ['easy', 'medium', 'hard'].sort((a, b) => values[b] - values[a]);
          for (const name of order) {
            while (total > target && values[name] > 0) {
              values[name] -= 1;
              total -= 1;
            }
          }
        } else if (total < target) {
          const order = ['easy', 'medium', 'hard'];
          for (const name of order) {
            while (total < target && values[name] < maxes[name]) {
              values[name] += 1;
              total += 1;
            }
          }
        }

        inputs.easy.value = values.easy;
        inputs.medium.value = values.medium;
        inputs.hard.value = values.hard;
        updateSumDisplay();
      });
    }

    window.applyTemplate = function (level) {
      const total = parseInt(rangeInput?.value || '{{ max_select }}', 10);
      let easy = 0, medium = 0, hard = 0;
      if (level === 'easy') {
        easy = Math.round(total * 0.7);
        medium = Math.round(total * 0.2);
        hard = total - easy - medium;
      } else if (level === 'medium') {
        easy = Math.round(total * 0.4);
        medium = Math.round(total * 0.4);
        hard = total - easy - medium;
      } else {
        easy = Math.round(total * 0.2);
        medium = Math.round(total * 0.3);
        hard = total - easy - medium;
      }

      inputs.easy.value = Math.max(0, Math.min(easy, maxes.easy));
      inputs.medium.value = Math.max(0, Math.min(medium, maxes.medium));
      inputs.hard.value = Math.max(0, Math.min(hard, maxes.hard));
      syncSliderFromInputs();
    };

    setDisabled();
    updateSumDisplay();
  })();

  // New timer system - pure JavaScript countdown
  (function() {
    const timerElement = document.getElementById('test-timer');
    const testForm = document.getElementById('test-form');
    const expiredInput = document.getElementById('time-expired');
    
    if (!timerElement || !testForm) return;
    
    const totalSeconds = parseInt(timerElement.dataset.duration, 10);
    if (!totalSeconds || totalSeconds <= 0) return;
    
    let remainingSeconds = totalSeconds;
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    function updateTimer() {
      timerElement.textContent = formatTime(remainingSeconds);
      
      if (remainingSeconds <= 0) {
        if (expiredInput) {
          expiredInput.value = '1';
        }
        testForm.submit();
        return;
      }
      
      remainingSeconds--;
      setTimeout(updateTimer, 1000);
    }
    
    // Start the timer immediately
    updateTimer();
  })();
</script>
{% endblock %}
