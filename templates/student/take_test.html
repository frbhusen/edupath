{% extends 'base.html' %}
{% block content %}
<div class="dashboard-hero mb-3 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h4 mb-1">{{ test.title }}</h1>
    <p class="mb-0">{{ test.description or 'أجب عن جميع الأسئلة أدناه.' }}</p>
  </div>
  {% if selected_count %}
    <div class="text-end">
      <div class="small text-muted">الوقت المتبقي</div>
      <div id="test-timer" class="badge text-bg-warning fs-6" data-duration="{{ time_limit_seconds }}">--:--</div>
    </div>
  {% endif %}
  <a class="btn btn-light btn-sm" href="{{ url_for('student.section_detail', section_id=test.section.id) }}">رجوع</a>
</div>

{% if not selected_count %}
  <form method="get" class="card shadow-sm">
    <div class="card-body">
      <label class="form-label" for="questionRange">كم عدد الأسئلة التي تريدها؟ (10-50)</label>
      {% if min_select == max_select %}
        <div class="d-flex align-items-center gap-3">
          <input type="hidden" name="count" value="{{ max_select }}" />
          <span class="badge text-bg-secondary">{{ max_select }}</span>
          <span class="text-muted small">خيار واحد فقط متاح.</span>
        </div>
      {% else %}
        <div class="d-flex align-items-center gap-3">
          <input
            type="range"
            class="form-range"
            id="questionRange"
            name="count"
            min="{{ min_select }}"
            max="{{ max_select }}"
            value="{{ max_select }}"
            oninput="document.getElementById('questionCountValue').textContent = this.value"
          />
          <span class="badge text-bg-secondary" id="questionCountValue">{{ max_select }}</span>
        </div>
      {% endif %}
      <div class="small text-muted mt-1">الأسئلة المتاحة: {{ total_questions }}</div>

      <div class="mt-4">
        <div class="fw-semibold mb-2">اختر توزيع الصعوبات</div>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <label class="form-label">سهل ({{ available_easy }})</label>
            <input class="form-control" type="number" name="easy" min="0" max="{{ available_easy }}" value="0" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">متوسط ({{ available_medium }})</label>
            <input class="form-control" type="number" name="medium" min="0" max="{{ available_medium }}" value="0" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">صعب ({{ available_hard }})</label>
            <input class="form-control" type="number" name="hard" min="0" max="{{ available_hard }}" value="0" />
          </div>
        </div>
        <div class="small text-muted mt-2">يجب أن يساوي مجموع المستويات العدد المختار.</div>
      </div>

      <div class="mt-4">
        <div class="fw-semibold mb-2">قوالب جاهزة</div>
        <div class="d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('easy')">سهل</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('medium')">متوسط</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('hard')">صعب</button>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-cta">بدء الاختبار</button>
      </div>
    </div>
  </form>
{% else %}
  <form method="post" id="test-form">
    <input type="hidden" name="question_ids" value="{{ question_ids_str }}" />
    <input type="hidden" name="time_expired" id="time-expired" value="0" />
    {% for item in ordered_questions %}
      {% set q = item.question %}
      {% set choices = item.choices %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <p class="fw-semibold">س{{ loop.index }}. {{ q.text }}</p>
          <div class="list-group">
            {% for c in choices %}
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input me-2" type="radio" name="question_{{ q.id }}" value="{{ c.choice_id }}">
                <span>{{ c.text }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
    <div class="d-grid">
      <button type="submit" class="btn btn-cta btn-lg">إرسال الإجابات</button>
    </div>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const rangeInput = document.getElementById('questionRange');
    const countBadge = document.getElementById('questionCountValue');
    const inputs = {
      easy: document.querySelector('input[name="easy"]'),
      medium: document.querySelector('input[name="medium"]'),
      hard: document.querySelector('input[name="hard"]')
    };

    const hasSetupForm = inputs.easy && inputs.medium && inputs.hard;
    if (!hasSetupForm) return;

    const maxes = {
      easy: parseInt(inputs.easy.getAttribute('max') || '0', 10),
      medium: parseInt(inputs.medium.getAttribute('max') || '0', 10),
      hard: parseInt(inputs.hard.getAttribute('max') || '0', 10)
    };

    function clamp(name) {
      const input = inputs[name];
      const max = maxes[name];
      let val = parseInt(input.value || '0', 10);
      if (Number.isNaN(val)) val = 0;
      val = Math.max(0, Math.min(val, max));
      input.value = val;
      return val;
    }

    function setDisabled() {
      Object.keys(inputs).forEach((name) => {
        if (maxes[name] === 0) {
          inputs[name].value = 0;
          inputs[name].disabled = true;
        } else {
          inputs[name].disabled = false;
        }
      });
    }

    function sumValues() {
      return clamp('easy') + clamp('medium') + clamp('hard');
    }

    function rebalance(target) {
      let values = {
        easy: clamp('easy'),
        medium: clamp('medium'),
        hard: clamp('hard')
      };

      let total = values.easy + values.medium + values.hard;

      if (total > target) {
        const order = ['easy', 'medium', 'hard'].sort((a, b) => values[b] - values[a]);
        for (const name of order) {
          while (total > target && values[name] > 0) {
            values[name] -= 1;
            total -= 1;
          }
        }
      } else if (total < target) {
        const order = ['easy', 'medium', 'hard'];
        for (const name of order) {
          while (total < target && values[name] < maxes[name]) {
            values[name] += 1;
            total += 1;
          }
        }
      }

      inputs.easy.value = values.easy;
      inputs.medium.value = values.medium;
      inputs.hard.value = values.hard;
    }

    function syncFromRange() {
      if (!rangeInput) return;
      const target = parseInt(rangeInput.value || '0', 10);
      if (countBadge) countBadge.textContent = target;
      setDisabled();
      rebalance(target);
    }

    function syncFromInputs() {
      if (!rangeInput) return;
      const target = parseInt(rangeInput.value || '0', 10);
      setDisabled();
      rebalance(target);
    }

    window.applyTemplate = function (level) {
      const total = parseInt(rangeInput?.value || '{{ max_select }}', 10);
      let easy = 0, medium = 0, hard = 0;
      if (level === 'easy') {
        easy = Math.round(total * 0.7);
        medium = Math.round(total * 0.2);
        hard = total - easy - medium;
      } else if (level === 'medium') {
        easy = Math.round(total * 0.4);
        medium = Math.round(total * 0.4);
        hard = total - easy - medium;
      } else {
        easy = Math.round(total * 0.2);
        medium = Math.round(total * 0.3);
        hard = total - easy - medium;
      }

      inputs.easy.value = easy;
      inputs.medium.value = medium;
      inputs.hard.value = hard;
      syncFromInputs();
    };

    if (rangeInput) {
      rangeInput.addEventListener('input', syncFromRange);
    }
    Object.values(inputs).forEach((input) => {
      input.addEventListener('input', syncFromInputs);
      input.addEventListener('change', syncFromInputs);
    });

    setDisabled();
    syncFromRange();
  })();

  // New timer system - pure JavaScript countdown
  (function() {
    const timerElement = document.getElementById('test-timer');
    const testForm = document.getElementById('test-form');
    const expiredInput = document.getElementById('time-expired');
    
    if (!timerElement || !testForm) return;
    
    const totalSeconds = parseInt(timerElement.dataset.duration, 10);
    if (!totalSeconds || totalSeconds <= 0) return;
    
    let remainingSeconds = totalSeconds;
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    function updateTimer() {
      timerElement.textContent = formatTime(remainingSeconds);
      
      if (remainingSeconds <= 0) {
        if (expiredInput) {
          expiredInput.value = '1';
        }
        testForm.submit();
        return;
      }
      
      remainingSeconds--;
      setTimeout(updateTimer, 1000);
    }
    
    // Start the timer immediately
    updateTimer();
  })();
</script>
{% endblock %}
